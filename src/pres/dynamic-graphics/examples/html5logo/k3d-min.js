var DEBUG=false;if(typeof K3D=="undefined"||!K3D){var K3D={}}K3D.DEPTHCUE=new Array(256);for(var c=0;c<256;c++){K3D.DEPTHCUE[c]="rgb("+c+","+c+","+c+")"}(function(){K3D.BaseController=function(){this.objects=[];this.lights=[];this.renderers=[];this.renderers.point=new K3D.PointRenderer();this.renderers.wireframe=new K3D.WireframeRenderer();this.renderers.solid=new K3D.SolidRenderer()};K3D.BaseController.prototype={renderers:null,objects:null,lights:null,addK3DObject:function(a){a.setController(this);this.objects.push(a)},addLightSource:function(a){this.lights.push(a)},getRenderer:function(a){return this.renderers[a]},processTick:function(d){var h=this.objects;for(var g=0,a=h.length;g<a;g++){h[g].executePipeline()}var f=this.lights;for(var g=0,a=f.length;g<a;g++){f[g].executePipeline()}h.forEach(function b(l,k,j){l.averagez=null});h.sort(function e(j,i){if(j.averagez===null){j.calculateAverageZ()}if(i.averagez===null){i.calculateAverageZ()}return(j.averagez<i.averagez?1:-1)});for(var g=0,a=h.length;g<a;g++){d.save();h[g].executeRenderer(d);d.restore()}}}})();(function(){K3D.Controller=function(b,a){K3D.Controller.superclass.constructor.call(this);this.canvas=b;var d=this;if(!a){b.onclick=function(e){d.paused=!d.paused;if(!d.paused){d.tick()}}}};extend(K3D.Controller,K3D.BaseController,{canvas:null,clearBackground:true,fillStyle:null,paused:true,callback:null,fps:40,lastFrameStart:0,addK3DObject:function(a){a.setController(this,this.canvas.width,this.canvas.height);this.objects.push(a)},tick:function(){var g=new Date().getTime();if(this.callback){this.callback.call(this)}var a=this.canvas.getContext("2d");if(this.clearBackground){if(this.fillStyle!==null){a.fillStyle=this.fillStyle;a.fillRect(0,0,this.canvas.width,this.canvas.height)}else{a.clearRect(0,0,this.canvas.width,this.canvas.height)}}this.processTick(a);var b=1000/this.fps;var f=(new Date().getTime()-g);if(!this.paused){var e=this;setTimeout(function(){e.tick()},b-f<=0?1:b-f)}if(DEBUG&&DEBUG.FPS){a.fillStyle="grey";a.fillText("TPF: "+f,4,48);var d=Math.round(1000/(g-this.lastFrameStart));a.fillText("FPS: "+d,4,64)}this.lastFrameStart=g}})})();(function(){K3D.BaseObject=function(){this.matrix=new Array(3);for(var a=0;a<3;a++){this.matrix[a]=new Array(3)}this.angles=new Array(6);return this};K3D.BaseObject.prototype={matrix:null,angles:null,offx:0,offy:0,offz:0,aboutx:0,abouty:0,aboutz:0,ogamma:0,otheta:0,ophi:0,addgamma:0,addtheta:0,addphi:0,velx:0,vely:0,velz:0,bminx:0,bminy:0,bminz:0,bmaxx:0,bmaxy:0,bmaxz:0,doublesided:false,calcMatrix:function(){var b=this.angles,a=this.matrix;b[0]=Math.sin(this.ogamma*RAD);b[1]=Math.cos(this.ogamma*RAD);b[2]=Math.sin(this.otheta*RAD);b[3]=Math.cos(this.otheta*RAD);b[4]=Math.sin(this.ophi*RAD);b[5]=Math.cos(this.ophi*RAD);a[0][0]=b[5]*b[1];a[1][0]=-(b[5]*b[0]);a[2][0]=b[4];a[0][1]=(b[2]*b[4]*b[1])+(b[3]*b[0]);a[1][1]=(b[3]*b[1])-(b[2]*b[4]*b[0]);a[2][1]=-(b[2]*b[5]);a[0][2]=(b[2]*b[0])-(b[3]*b[4]*b[1]);a[1][2]=(b[2]*b[1])+(b[3]*b[4]*b[0]);a[2][2]=b[3]*b[5]},transformToWorld:function(){},executePipeline:function(){this.ogamma+=this.addgamma;this.otheta+=this.addtheta;this.ophi+=this.addphi;this.offx+=this.velx;this.offy+=this.vely;this.offz+=this.velz;if(this.offx<this.bminx||this.offx>this.bmaxx){this.velx*=-1}if(this.offy<this.bminy||this.offy>this.bmaxy){this.vely*=-1}if(this.offz<this.bminz||this.offz>this.bmaxz){this.velz*=-1}this.calcMatrix();this.transformToWorld()}}})();(function(){K3D.K3DObject=function(){K3D.K3DObject.superclass.constructor.call(this);this.textures=[];return this};extend(K3D.K3DObject,K3D.BaseObject,{controller:null,worldcoords:null,screenx:0,screeny:0,depthscale:0,linescale:2,color:null,drawmode:"point",shademode:"depthcue",sortmode:"sorted",fillstroke:true,perslevel:512,scale:0,points:null,edges:null,faces:null,screencoords:null,averagez:null,textures:null,recalculateNormals:false,init:function(o,g,d){this.points=o;this.edges=g;this.faces=d;this.worldcoords=new Array(o.length+d.length);for(var k=0,f=this.worldcoords.length;k<f;k++){this.worldcoords[k]={x:0,y:0,z:0}}this.screencoords=new Array(o.length);for(var k=0,f=this.screencoords.length;k<f;k++){this.screencoords[k]={x:0,y:0}}if(this.scale!==0){for(var k=0,f=this.points.length;k<f;k++){o[k].x*=this.scale;o[k].y*=this.scale;o[k].z*=this.scale}}if(this.color===null){this.color=[255,255,255]}for(var k=0,f=d.length;k<f;k++){var l=d[k].vertices;var b=o[l[1]].x-o[l[0]].x;var n=o[l[1]].y-o[l[0]].y;var h=o[l[1]].z-o[l[0]].z;var a=o[l[2]].x-o[l[0]].x;var m=o[l[2]].y-o[l[0]].y;var e=o[l[2]].z-o[l[0]].z;d[k].normal=calcNormalVector(b,n,h,a,m,e);if(!d[k].color){d[k].color=this.color}if(d[k].texture===undefined){d[k].texture=null}}},setController:function(a,b,d){this.controller=a;if(b){this.screenx=b/2;this.screeny=d/2;this.depthscale=this.screenx;this.bminx=-this.screenx;this.bminy=-this.screeny;this.bminz=-this.screenx;this.bmaxx=this.screenx;this.bmaxy=this.screeny;this.bmaxz=this.screenx}},transformToWorld:function(){var l,j,g;var q=this.points,f=this.worldcoords,b=this.faces,o=this.matrix;var m=this.aboutx,k=this.abouty,h=this.aboutz,e=this.offx,d=this.offy,a=this.offz;var s=o[0],p=o[1],n=o[2];for(var r=0,t=q.length;r<t;r++){l=q[r].x+m;j=q[r].y+k;g=q[r].z+h;f[r].x=(s[0]*l)+(s[1]*j)+(s[2]*g)+e;f[r].y=(p[0]*l)+(p[1]*j)+(p[2]*g)+d;f[r].z=(n[0]*l)+(n[1]*j)+(n[2]*g)+a}for(var r=0,t=b.length,u;r<t;r++){u=b[r].normal;l=u.x;j=u.y;g=u.z;b[r].worldnormal=new Vector3D((s[0]*l)+(s[1]*j)+(s[2]*g)+e,(p[0]*l)+(p[1]*j)+(p[2]*g)+d,(n[0]*l)+(n[1]*j)+(n[2]*g)+a)}},transformToScreen:function(){var j,g,f;var a=this.worldcoords,h=this.screencoords;var l=this.screenx,k=this.screeny,e=this.perslevel;for(var b=0,d=this.points.length;b<d;b++){j=a[b].x;g=a[b].y;f=a[b].z+e;if(f===0){f=1}h[b].x=((j*e)/f)+l;h[b].y=k-((g*e)/f)}},executePipeline:function(){if(this.recalculateNormals){var d=this.faces,n=this.points;for(var h=0,f=d.length;h<f;h++){var k=d[h].vertices;var b=n[k[1]].x-n[k[0]].x;var m=n[k[1]].y-n[k[0]].y;var g=n[k[1]].z-n[k[0]].z;var a=n[k[2]].x-n[k[0]].x;var l=n[k[2]].y-n[k[0]].y;var e=n[k[2]].z-n[k[0]].z;d[h].normal=calcNormalVector(b,m,g,a,l,e)}}K3D.K3DObject.superclass.executePipeline.call(this);this.transformToScreen();this.controller.getRenderer(this.drawmode).sortByDistance(this)},executeRenderer:function(a){this.controller.getRenderer(this.drawmode).renderObject(this,a)},calculateAverageZ:function(){var e=0;var d=this.worldcoords;for(var b=0,a=this.points.length;b<a;b++){e+=d[b].z}this.averagez=e/this.points.length}})})();(function(){K3D.LightSource=function(b,d,a){K3D.LightSource.superclass.constructor.call(this);this.location=b;this.color=d;this.intensity=a;return this};extend(K3D.LightSource,K3D.BaseObject,{color:null,intensity:null,location:null,worldvector:null,transformToWorld:function(){var b=this.matrix;var a=this.location.x+this.aboutx;var e=this.location.y+this.abouty;var d=this.location.z+this.aboutz;this.worldvector=new Vector3D((b[0][0]*a)+(b[0][1]*e)+(b[0][2]*d)+this.offx,(b[1][0]*a)+(b[1][1]*e)+(b[1][2]*d)+this.offy,(b[2][0]*a)+(b[2][1]*e)+(b[2][2]*d)+this.offz)}})})();(function(){K3D.Renderer=function(){};K3D.Renderer.prototype={sortByDistance:function(a){},renderObject:function(b,a){}}})();(function(){K3D.PointRenderer=function(){K3D.PointRenderer.superclass.constructor.call(this);return this};extend(K3D.PointRenderer,K3D.Renderer,{sortByDistance:function(a){if(a.shademode!=="plain"&&a.sortmode==="sorted"){this.quickSortObject(a.screencoords,a.worldcoords,0,a.points.length-1)}},quickSortObject:function(i,d,j,e){var f=j,h=e,g;var b;if(e>j){g=d[(j+e)>>1].z/2;while(f<=h){while(f<e&&d[f].z>g){f++}while(h>j&&d[h].z<g){h--}if(f<=h){b=i[f];i[f]=i[h];i[h]=b;b=d[f];d[f]=d[h];d[h]=b;f++;h--}}if(j<h){this.quickSortObject(i,d,j,h)}if(f<e){this.quickSortObject(i,d,f,e)}}},renderObject:function(f,m){var b,h,k;var j=f.screencoords,d=f.worldcoords,n=f.depthscale,a=n/128,l=f.linescale/255;for(var e=0,g=f.points.length;e<g;e++){h=d[e].z+n;h=h/a;switch(f.shademode){case"lightsource":case"plain":m.fillStyle="rgb("+f.color[0]+","+f.color[1]+","+f.color[2]+")";break;case"depthcue":if(h<0){h=0}if(h>255){h=255}h=255-Math.ceil(h);m.fillStyle=K3D.DEPTHCUE[h];break}k=l*h;if(k<0.1){k=0.1}m.beginPath();m.arc(j[e].x,j[e].y,k,0,TWOPI,true);m.closePath();m.fill()}}})})();(function(){K3D.WireframeRenderer=function(){K3D.WireframeRenderer.superclass.constructor.call(this);return this};extend(K3D.WireframeRenderer,K3D.Renderer,{sortByDistance:function(a){if(a.shademode!=="plain"&&a.sortmode==="sorted"){this.quickSortObject(a.worldcoords,a.edges,0,a.edges.length-1)}},quickSortObject:function(j,b,i,d){var e=i,h=d,f;var g;if(d>i){f=((j[(b[(i+d)>>1].a)].z)+(j[(b[(i+d)>>1].b)].z))/2;while(e<=h){while((e<d)&&((j[(b[e].a)].z+j[(b[e].b)].z)/2>f)){e++}while((h>i)&&((j[(b[h].a)].z+j[(b[h].b)].z)/2<f)){h--}if(e<=h){g=b[e];b[e]=b[h];b[h]=g;e++;h--}}if(i<h){this.quickSortObject(j,b,i,h)}if(e<d){this.quickSortObject(j,b,e,d)}}},renderObject:function(h,q){var k,n,m,o;var f=h.edges,l=h.screencoords,e=h.worldcoords;var r=h.depthscale,d=r/128,p=h.linescale/255;for(var g=0,j=f.length;g<j;g++){n=f[g].a;m=f[g].b;switch(h.shademode){case"lightsource":case"plain":k=h.color;q.fillStyle="rgb("+k[0]+","+k[1]+","+k[2]+")";break;case"depthcue":k=((e[n].z+e[m].z)/2)+r;k=k/d;if(k<0){k=0}if(k>255){k=255}k=255-Math.ceil(k);q.strokeStyle=K3D.DEPTHCUE[k];o=p*k;q.lineWidth=(o>0.1?o:0.1);break}q.beginPath();q.moveTo(l[n].x,l[n].y);q.lineTo(l[m].x,l[m].y);q.closePath();q.stroke()}}})})();(function(){K3D.SolidRenderer=function(){K3D.SolidRenderer.superclass.constructor.call(this);return this};extend(K3D.SolidRenderer,K3D.Renderer,{sortByDistance:function b(f){if(f.sortmode==="sorted"){this.quickSortObject(f.worldcoords,f.faces,0,f.faces.length-1)}},quickSortObject:function a(k,s,h,t){var r=h,g=t,q,p,o,f;if(t>h){o=s[(h+t)>>1].vertices;for(var m=0,l=o.length,n=0;m<l;m++){n+=k[o[m]].z}q=n/o.length;while(r<=g){while(true){o=s[r].vertices;for(var m=0,l=o.length,n=0;m<l;m++){n+=(k[o[m]].z)}f=n/o.length;if(r<t&&f>q){r++}else{break}}while(true){o=s[g].vertices;for(var m=0,l=o.length,n=0;m<l;m++){n+=k[o[m]].z}f=n/o.length;if(g>h&&f<q){g--}else{break}}if(r<=g){p=s[r];s[r]=s[g];s[g]=p;r++;g--}}if(h<g){this.quickSortObject(k,s,h,g)}if(r<t){this.quickSortObject(k,s,r,t)}}},renderObject:function d(x,B){var k=x.faces,l=x.screencoords,q=x.worldcoords;var o=x.depthscale,J=o/128;var y=new Vector3D(0,0,1);var t,z,F,I,H,w=Math.PI/2,s;var L=x.controller.lights;var K=x.doublesided;for(var A=0,E=k.length,v;A<E;A++){v=k[A];t=v.vertices;var G=y.thetaTo(v.worldnormal);if(K||(G+0.15>w)){switch(x.shademode){case"plain":if(v.texture===null){H=v.color;s="rgb("+H[0]+","+H[1]+","+H[2]+")";this.renderPolygon(B,x,v,s)}else{this.renderPolygon(B,x,v)}break;case"depthcue":for(var D=0,C=t.length,u=0;D<C;D++){u+=q[t[D]].z}var p=((u/t.length)+o)/J;if(p<0){p=0}if(p>255){p=255}if(v.texture===null){p=(255-p)/255;H=v.color;z=Math.ceil(p*H[0]);F=Math.ceil(p*H[1]);I=Math.ceil(p*H[2]);s="rgb("+z+","+F+","+I+")"}else{p=255-Math.ceil(p);s="rgba(0,0,0,"+(1-(p/255))+")"}this.renderPolygon(B,x,v,s);break;case"lightsource":if(L.length===0){H=v.color;z=Math.ceil(G*(H[0]/Math.PI));F=Math.ceil(G*(H[1]/Math.PI));I=Math.ceil(G*(H[2]/Math.PI));if(v.texture===null){s="rgb("+z+","+F+","+I+")"}else{s="rgba(0,0,0,"+(1-G*(1/Math.PI))+")"}this.renderPolygon(B,x,v,s)}else{z=0;F=0;I=0;for(var D=0,C=L.length,m,f;D<C;D++){m=L[D];G=Math.PI-m.worldvector.thetaTo(v.worldnormal);f=G*((1/m.worldvector.distance(v.worldnormal))*m.intensity)/Math.PI;z+=(f*m.color[0]);F+=(f*m.color[1]);I+=(f*m.color[2])}if(z>1){z=1}if(F>1){F=1}if(I>1){I=1}H=v.color;var h=Math.ceil(z*H[0])+","+Math.ceil(F*H[1])+","+Math.ceil(I*H[2]);if(v.texture===null){s="rgb("+h+")"}else{s="rgba("+h+","+(1-(z+F+I)/3)+")"}this.renderPolygon(B,x,v,s)}break}}}},renderPolygon:function e(x,w,q,o){var h=w.screencoords,p=q.vertices;x.save();x.beginPath();x.moveTo(h[p[0]].x,h[p[0]].y);for(var B=1,z=p.length;B<z;B++){x.lineTo(h[p[B]].x,h[p[B]].y)}x.closePath();if(q.texture===null){x.fillStyle=o;x.fill();if(w.fillstroke){x.strokeStyle=o;x.stroke()}}else{x.clip();var I=w.textures[q.texture];var t=16,D=16,s=I.width-16,A=16,r=I.width-16,y=I.height-16;var F=h[p[0]].x,l=h[p[0]].y,E=h[p[1]].x,k=h[p[1]].y,C=h[p[2]].x,g=h[p[2]].y;var f=I.denom;if(f===undefined){f=t*(y-A)-s*y+r*A+(s-r)*D;I.denom=f}var H=-(D*(C-E)-A*C+y*E+(A-y)*F)/f;var G=(A*g+D*(k-g)-y*k+(y-A)*l)/f;var n=(t*(C-E)-s*C+r*E+(s-r)*F)/f;var m=-(s*g+t*(k-g)-r*k+(r-s)*l)/f;var v=(t*(y*E-A*C)+D*(s*C-r*E)+(r*A-s*y)*F)/f;var u=(t*(y*k-A*g)+D*(s*g-r*k)+(r*A-s*y)*l)/f;x.transform(H,G,n,m,v,u);x.drawImage(I,0,0);if(o){x.fillStyle=o;x.fill()}}x.restore()}})})();